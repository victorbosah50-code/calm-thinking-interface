<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸŒ¿ Calm Thinking Interactive Journey ðŸŒ¿</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
<style>
html,body{margin:0;padding:0;height:100%;font-family:'Nunito',sans-serif;background:#000;overflow-y:auto;}
#bgVideo{position:fixed;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:-3;opacity:0.6;}
.rain-container{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:-2;overflow:hidden;}
.drop{position:absolute;width:2px;height:15px;background:rgba(255,255,255,0.3);bottom:100%;animation-name:fall;animation-timing-function:linear;animation-iteration-count:infinite;}
@keyframes fall{to{transform:translateY(110vh);opacity:0;}}
.container{max-width:900px;margin:40px auto;padding:36px;background:rgba(255,255,255,.25);backdrop-filter:blur(14px);border-radius:24px;color:#000;text-align:center;}
img{width:100%;max-height:280px;object-fit:cover;border-radius:18px;margin:16px 0;}
textarea{width:100%;height:120px;padding:14px;border-radius:14px;border:2px solid #7fd3e8;font-family:Nunito;font-size:1rem;}
button{padding:12px 28px;margin:14px;border:none;border-radius:18px;background:#4a90e2;color:#fff;font-size:1rem;cursor:pointer;}
.card{background:rgba(255,255,255,.35);padding:24px;border-radius:22px;margin-top:20px;}
.breath{width:200px;height:200px;border-radius:50%;background:radial-gradient(circle,#b3e5fc,#81d4fa);margin:26px auto;display:flex;align-items:center;justify-content:center;font-size:1.4rem;font-weight:700;transition:2.5s;}
.expand{transform:scale(1.8);}
.small{font-size:.9rem;opacity:.85;}
</style>
</head>
<body>

<video autoplay muted loop id="bgVideo" src="https://interactive-examples.mdn.mozilla.net/media/cc0-videos/forest.mp4"></video>
<div class="rain-container" id="rain"></div>

<div class="container" id="app">
  <h1>ðŸŒ¿ Calm Thinking Interactive Journey</h1>
  <p>Begin a deeply therapeutic, adaptive session personalized to you.</p>
  <label for="voiceSelect">Choose your voice:</label>
  <select id="voiceSelect">
    <option value="none" selected>No voice</option>
    <option value="male">Male</option>
    <option value="female">Female</option>
  </select>
  <br>
  <button id="startBtn">Begin Session</button>
</div>

<audio id="ambience" loop></audio>

<script>
const app=document.getElementById("app");
const ambience=document.getElementById("ambience");
const bgVideo=document.getElementById("bgVideo");
const rainContainer=document.getElementById("rain");
const voiceSelect=document.getElementById("voiceSelect");
const synth=window.speechSynthesis;

let step=0,responses=[],selectedVoice='none',flow=[],mood='Neutral';

/* ---------- FULLY WORKING RAIN EFFECT ---------- */
function createRain(count){
  rainContainer.innerHTML=""; // clear existing
  for(let i=0;i<count;i++){
    const drop=document.createElement("div");
    drop.className="drop";
    drop.style.left=Math.random()*100+"%";
    drop.style.animationDuration=(0.5+Math.random()*0.7)+"s";
    drop.style.animationDelay=(Math.random()*5)+"s";
    drop.style.opacity=(0.2+Math.random()*0.4);
    rainContainer.appendChild(drop);
  }
}
createRain(150);

/* ---------- RANDOMIZED QUESTION SETS ---------- */
const questionSets=[
  [
    "Whatâ€™s on your mind today?",
    "What feeling is strongest right now?",
    "What can you focus on controlling?",
    "What do you need to release?",
    "BREATH",
    "Name one small act of self-care you will do."
  ],
  [
    "Recall a positive moment from this week.",
    "What challenge feels heaviest?",
    "Which action was meaningful today?",
    "Identify something outside your control.",
    "BREATH",
    "What intention will guide your next hour?"
  ],
  [
    "How do you feel right now?",
    "What thought keeps returning?",
    "What can you let go?",
    "What can you embrace?",
    "BREATH",
    "Name one thing that brings calm to you."
  ]
];

/* ---------- NATURE IMAGE OPTIONS ---------- */
const natureImages=[
  "https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=900&q=80",
  "https://images.unsplash.com/photo-1506744038136-45673834b3fb?auto=format&fit=crop&w=900&q=80",
  "https://images.unsplash.com/photo-1506744038136-46273834b3fc?auto=format&fit=crop&w=900&q=80",
  "https://images.unsplash.com/photo-1506744038136-46273834b3fd?auto=format&fit=crop&w=900&q=80"
];

/* ---------- VOICE ---------- */
function speak(text){
  if(selectedVoice==='none') return;
  if(!synth) return;
  synth.cancel();
  const utter=new SpeechSynthesisUtterance(text);
  const voices=synth.getVoices();
  let chosenVoice;
  if(selectedVoice==='female') chosenVoice=voices.find(v=>v.name.toLowerCase().includes("female")) || voices.find(v=>v.lang.startsWith("en"));
  if(selectedVoice==='male') chosenVoice=voices.find(v=>v.name.toLowerCase().includes("male")) || voices.find(v=>v.lang.startsWith("en"));
  utter.voice=chosenVoice;
  utter.rate=0.9;
  utter.pitch=1;
  synth.speak(utter);
}

/* ---------- START SESSION ---------- */
document.getElementById("startBtn").onclick=()=>{
  selectedVoice=voiceSelect.value;
  ambience.src="https://www.orangefreesounds.com/wp-content/uploads/2016/04/Rainforest-sounds.mp3";
  ambience.volume=.45;
  ambience.play();
  flow=questionSets[Math.floor(Math.random()*questionSets.length)];
  renderStep();
};

/* ---------- RENDER STEP ---------- */
function renderStep(){
  if(step>=flow.length){conclude(); return;}
  if(flow[step]==="BREATH"){breathing(); return;}
  
  const userImg=natureImages[Math.floor(Math.random()*natureImages.length)];
  app.innerHTML=`
    <h2>${flow[step]}</h2>
    <img src="${userImg}" alt="Calm Nature">
    <textarea placeholder="Write freely..."></textarea>
    <button>Continue</button>
  `;
  speak(flow[step]);
  
  app.querySelector("button").onclick=()=>{
    const val=app.querySelector("textarea").value.trim();
    if(!val){alert("Write at least a few words.");return;}
    responses.push(val);
    analyzeMood(val);
    if(responses.length%2===0){adaptiveMicroGame(responses.slice(-2));} else {brainGame(step);}
  };
}

/* ---------- EMOTIONAL TONE ANALYSIS ---------- */
function analyzeMood(text){
  const lower=text.toLowerCase();
  let score=0;
  ["calm","peace","relax","joy","happy"].forEach(w=>{if(lower.includes(w)) score+=2;});
  ["stress","tired","worry","anxious"].forEach(w=>{if(lower.includes(w)) score-=2;});
  ["focus","goal","plan","success"].forEach(w=>{if(lower.includes(w)) score+=1;});
  if(score>=3) mood="Calm"; else if(score<=-2) mood="Stressed"; else if(score>0) mood="Motivated"; else mood="Neutral";
  dynamicBackground(mood);
}

/* ---------- DYNAMIC BACKGROUND BASED ON MOOD ---------- */
function dynamicBackground(mood){
  if(mood==="Calm") bgVideo.src=natureImages[0];
  else if(mood==="Stressed") bgVideo.src="https://images.unsplash.com/photo-1506744038136-46273834b3fe?auto=format&fit=crop&w=900&q=80";
  else if(mood==="Motivated") bgVideo.src=natureImages[2];
  else bgVideo.src=natureImages[3];
}

/* ---------- REST OF THE LOGIC (BREATH, BRAIN GAMES, CONCLUSION ETC.) ---------- */
/* Reuse the previous full logic from the last working version: breathing(), brainGame(), adaptiveMicroGame(), triviaGame(), memoryGame(), patternGame(), conclude() */

</script>
</body>
</html>
