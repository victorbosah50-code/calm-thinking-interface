<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Calm Thinking ‚Äì Personalized Therapeutic Session</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
<style>
html,body{margin:0;min-height:100%;font-family:'Nunito',sans-serif;background:#000;}
body{overflow-y:auto;}
#bg{position:fixed;inset:0;background:linear-gradient(to top,#0b2c3d,#000);z-index:-3;}
.rain{position:fixed;inset:0;pointer-events:none;z-index:-2}
.drop{position:absolute;width:2px;height:18px;background:rgba(255,255,255,.35);animation:fall linear infinite;}
@keyframes fall{to{transform:translateY(120vh)}}
.container{max-width:880px;margin:40px auto;padding:34px;background:rgba(255,255,255,.28);backdrop-filter:blur(14px);border-radius:24px;color:#000;text-align:center;}
img{width:100%;max-height:260px;object-fit:cover;border-radius:18px;margin:14px 0;}
textarea{width:100%;height:120px;padding:14px;border-radius:14px;border:2px solid #7fd3e8;font-family:Nunito;font-size:1rem;}
button{padding:12px 30px;margin:14px;border:none;border-radius:18px;background:#4a90e2;color:#fff;font-size:1rem;cursor:pointer;}
.card{background:rgba(255,255,255,.35);padding:24px;border-radius:22px;margin-top:20px;}
.breath{width:200px;height:200px;border-radius:50%;background:radial-gradient(circle,#b3e5fc,#81d4fa);margin:26px auto;display:flex;align-items:center;justify-content:center;font-size:1.4rem;font-weight:700;transition:2.5s;}
.expand{transform:scale(1.8)}
.small{font-size:.9rem;opacity:.85}
</style>
</head>
<body>

<div id="bg"></div>
<div class="rain" id="rain"></div>

<div class="container" id="app">
  <h1>üåø Calm Thinking</h1>
  <p>A gentle therapeutic space to slow your mind and reconnect.</p>
  <label for="voiceSelect">Choose your voice:</label>
  <select id="voiceSelect">
    <option value="none" selected>No voice</option>
    <option value="male">Male</option>
    <option value="female">Female</option>
  </select>
  <br>
  <button id="startBtn">Begin Session</button>
</div>

<audio id="ambience" loop src="https://www.orangefreesounds.com/wp-content/uploads/2016/04/Rainforest-sounds.mp3"></audio>

<script>
const app=document.getElementById("app");
const ambience=document.getElementById("ambience");
const rain=document.getElementById("rain");
const voiceSelect=document.getElementById("voiceSelect");
const synth=window.speechSynthesis;

let step=0;
let responses=[];
let selectedVoice='none';

/* ---------- RAIN ---------- */
for(let i=0;i<140;i++){
  const d=document.createElement("div");
  d.className="drop";
  d.style.left=Math.random()*100+"%";
  d.style.animationDuration=(0.6+Math.random())+"s";
  d.style.animationDelay=Math.random()*6+"s";
  rain.appendChild(d);
}

/* ---------- FLOW ---------- */
const flow=[
  "What has been occupying your thoughts lately?",
  "What feels emotionally heavy right now?",
  "What part of this situation is outside your control?",
  "What part is still within your control?",
  "BREATH",
  "What is one kind thing you can offer yourself today?"
];

const images=[
  "https://images.unsplash.com/photo-1506744038136-46273834b3fb",
  "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee",
  "https://images.unsplash.com/photo-1493244040629-496f6d136cc8",
  "https://images.unsplash.com/photo-1441974231531-c6227db76b6e",
  "",
  "https://images.unsplash.com/photo-1501785888041-af3ef285b470"
];

/* ---------- VOICE ---------- */
function speak(text){
  if(selectedVoice==='none') return;
  if(!synth) return;
  synth.cancel();
  const utter=new SpeechSynthesisUtterance(text);
  const voices=synth.getVoices();
  if(selectedVoice==='female') utter.voice=voices.find(v=>v.name.toLowerCase().includes('female'))||voices[0];
  if(selectedVoice==='male') utter.voice=voices.find(v=>v.name.toLowerCase().includes('male'))||voices[0];
  utter.rate=0.9;
  utter.pitch=1;
  synth.speak(utter);
}

/* ---------- START ---------- */
startBtn.onclick=()=>{
  selectedVoice=voiceSelect.value;
  ambience.volume=.45;
  ambience.play();
  renderStep();
};

/* ---------- STEP ---------- */
function renderStep(){
  if(step>=flow.length){ conclude(); return; }

  if(flow[step]==="BREATH"){ breathing(); return; }

  speak(flow[step]);

  app.innerHTML=`
    <h2>${flow[step]}</h2>
    <img src="${images[step]}" alt="Calm nature">
    <textarea placeholder="Write freely. There is no judgment."></textarea>
    <button>Continue</button>
  `;

  app.querySelector("button").onclick=()=>{
    const text=app.querySelector("textarea").value.trim();
    if(!text){alert("Even a few words are enough.");return;}
    responses.push(text);

    if(responses.length % 2 === 0){
      adaptiveMicroGame(responses.slice(-2));
    } else {
      brainGame(step);
    }
  };
}

/* ---------- THERAPEUTIC BRAIN GAMES ---------- */
function brainGame(i){
  const games=[
    "Write three thoughts you want to gently set aside.",
    "Rewrite one sentence you wrote with kindness.",
    "Name one thing you are carrying that is not yours to carry.",
    "Choose one small focus that feels manageable.",
    "",
    "Name one gentle action you will take today."
  ];

  if(!games[i]){step++;renderStep();return;}

  speak(games[i]);

  app.innerHTML=`
    <div class="card">
      <h3>üß† Therapeutic Focus</h3>
      <p>${games[i]}</p>
      <textarea></textarea>
      <button>Continue</button>
    </div>
  `;

  app.querySelector("button").onclick=()=>{
    step++;
    renderStep();
  };
}

/* ---------- ADAPTIVE MICRO-GAMES ---------- */
function adaptiveMicroGame(lastTwoResponses){
  const text=lastTwoResponses.join(" ");
  let keywords=text.match(/\b\w{4,}\b/g) || [];
  keywords=keywords.slice(0,5);
  if(keywords.length===0) keywords=["calm","focus","mind"];

  const games=[triviaFromResponses,memoryFromResponses,patternFromResponses];
  const g=games[Math.floor(Math.random()*games.length)];
  g(keywords);
}

/* ---------- TRIVIA BASED ON RESPONSES ---------- */
function triviaFromResponses(keywords){
  const q="Which of these words resonates most with your current feelings?";
  const options=[...keywords].sort(()=>Math.random()-0.5);
  let buttons="";
  options.forEach(o=>buttons+=`<button>${o}</button>`);

  app.innerHTML=`
    <div class="card">
      <h3>üß© Personalized Mindfulness Trivia</h3>
      <p>${q}</p>
      ${buttons}
    </div>
  `;

  app.querySelectorAll("button").forEach(b=>{
    b.onclick=()=>{
      alert(`You selected: "${b.textContent}". Reflect on this choice.`);
      step++;
      renderStep();
    };
  });
}

/* ---------- MEMORY GAME BASED ON RESPONSES ---------- */
function memoryFromResponses(words){
  const sequence=words.slice(0,3);
  let userSeq=[];
  app.innerHTML=`
    <div class="card">
      <h3>üß† Memory Sequence</h3>
      <p>Memorize this sequence:</p>
      <p>${sequence.join(" ")}</p>
      <button id="startMem">Start Recall</button>
    </div>
  `;
  document.getElementById("startMem").onclick=()=>{
    const inputs=sequence.map(s=>`<button>${s}</button>`).join(" ");
    app.innerHTML=`
      <div class="card">
        <h3>Recall the sequence</h3>
        <p>Click in the order you saw:</p>
        ${inputs}
      </div>
    `;
    const btns=app.querySelectorAll("button");
    btns.forEach((b,i)=>{
      b.onclick=()=>{
        userSeq.push(b.textContent);
        b.disabled=true;
        if(userSeq.length===sequence.length){
          const score=userSeq.filter((v,i)=>v===sequence[i]).length;
          alert(`‚úÖ You recalled ${score}/${sequence.length} correctly!`);
          step++;
          renderStep();
        }
      };
    });
  };
}

/* ---------- PATTERN GAME BASED ON RESPONSES ---------- */
function patternFromResponses(words){
  const pattern=words.map(w=>w[0]+"*");
  let user=[];
  app.innerHTML=`
    <div class="card">
      <h3>üåà Pattern Spotting</h3>
      <p>Click the elements in alternating pattern:</p>
      ${pattern.map(p=>`<button>${p}</button>`).join("")}
    </div>
  `;
  app.querySelectorAll("button").forEach((b,i)=>{
    b.onclick=()=>{
      user.push(b.textContent);
      b.disabled=true;
      if(user.length===pattern.length){
        const score=user.filter((v,i)=>v===pattern[i]).length;
        alert(`‚úÖ You matched ${score}/${pattern.length} correctly!`);
        step++;
        renderStep();
      }
    };
  });
}

/* ---------- BREATHING ---------- */
function breathing(){
  let p=0;
  speak("Follow the breath. Inhale. Hold. Exhale.");
  app.innerHTML=`
    <h2>üåå Guided Breathing</h2>
    <p class="small">Follow the rhythm. Nothing else to do.</p>
    <div class="breath" id="b">Inhale</div>
    <button>Continue</button>
  `;
  const b=document.getElementById("b");
  const t=setInterval(()=>{
    if(p===0){b.textContent="Inhale";b.classList.add("expand")}
    if(p===1){b.textContent="Hold"}
    if(p===2){b.textContent="Exhale";b.classList.remove("expand")}
    p=(p+1)%3;
  },2200);

  app.querySelector("button").onclick=()=>{
    clearInterval(t);
    step++;
    renderStep();
  };
}

/* ---------- CONCLUSION (Fully Personalized) ---------- */
function conclude(){
  speak("You showed up for yourself today.");
  const userText=responses.join(" ").toLowerCase();

  // Word of the Day: longest meaningful word
  const wordList=userText.match(/\b\w{5,}\b/g)||["Presence"];
  const word=wordList.sort((a,b)=>b.length-a.length)[0];

  // Quote dynamically from sentiment keywords
  let quote="Reflecting on yourself brings clarity.";
  if(userText.includes("stress")||userText.includes("worry")) quote="Even tension can become awareness with presence.";
  else if(userText.includes("happy")||userText.includes("joy")) quote="Joy magnifies as you notice it deeply.";

  // Idiom dynamically
  let idiom="Step by step, progress is made.";
  if(userText.includes("control")) idiom="Let go to grow.";

  // Parable dynamically
  let parable="A traveler paused under a tree and felt renewed.";
  if(userText.includes("heavy")||userText.includes("burden")) parable="Even the heaviest load eases when shared with care.";

  app.innerHTML=`
    <h2>üå± Session Complete</h2>
    <div class="card"><h3>üìñ Word of the Day</h3><p><strong>${word}</strong><br>Derived from your reflections.</p></div>
    <div class="card"><h3>üí¨ Quote of the Day</h3><p><em>${quote}</em></p></div>
    <div class="card"><h3>üó£Ô∏è Idiom of the Day</h3><p>${idiom}</p></div>
    <div class="card"><h3>üìú Parable of the Day</h3><p>${parable}</p></div>
    <p class="small">Return anytime. This space remembers you.</p>
  `;
}
</script>
</body>
</html>
